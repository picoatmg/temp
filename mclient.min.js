// ANSI.js -- an ansi to html printer.
// Same as TANSI.js by XRM/YEN, but removed all code related to
// input (e.g. text input field, input buffer, prompt) to reduce
// code coupling.
//
// Based on:
//
// TANSI.js -- a telnet-ansi-replacement for VT100 which drops some of the
// extravagant features (set cursor to certain locations, f.e.), but which
// provides scrollback, command history and a separate command line.
//
// Written by XRM from github.com / YEN from nightfall.org 19jun13
// Bases on VT100.js by Frank Bi <bi@zompower.tk>
//				db.restoreAll("rooms",function(roomId,loadedRoom) {
//					console.log('LOADED: '+JSON.stringify(loadedRoom));
//					injectRoomInfoToMudmap(loadedRoom);
//				},function() {
//				});
// compiles all local data into a JSON string and
// passes that as argument to function 'onSuccess'
// replaces all local data by the data in the given JSON string
//console.log("RESIZE to ("+width+", "+height+")");
//	EXPORT.setOffset(mapWindowPixelWidth/2, mapWindowPixelHeight/2, false);
// polyfills ...
// TODO !!!!!!!!!!!!!!!
//					that.setPageSize(1);
//		that.disconnect();
//tile.println("keyCode = "+event.keyCode);
// collect words for auto-completion from the end of the input buffer
// ################################################################################
//   class Tile
// ################################################################################
// ################################################################################
//   configuration
// ################################################################################
// ################################################################################
//   event handling
// ################################################################################
//tile.println('x:'+posInfo.pageX+' ; y:'+posInfo.pageY);
//drag.tile.println('x:'+posInfo.pageX+' ; y:'+posInfo.pageY);
// From: http://hg.mozilla.org/mozilla-central/raw-file/ec10630b1a54/js/src/devtools/jint/sunspider/string-base64.js
// Globals defined here
// IE does not support map (even in IE9)
//This prototype is provided by the Mozilla foundation and
//is distributed under the MIT license.
//http://www.ibiblio.org/pub/Linux/LICENSES/mit.license
// 
// requestAnimationFrame shim with setTimeout fallback
//
// Initialize logging level
// Set configuration default for Crockford style function namespaces
// Set group of configuration defaults
// Dynamically load scripts without using document.write()
// Reference: http://unixpapa.com/js/dyna.html
//
// Handles the case where load_scripts is invoked from a script that
// itself is loaded via load_scripts. Once all scripts are loaded the
// window.onscriptsloaded handler is called (if set).
// Get DOM element position on page
// Get mouse event position in DOM element
// Event registration. Based on: http://www.scottandrew.com/weblog/articles/cbs-events
// Set browser engine versions. Based on mootools.
// Load Flash WebSocket emulator if needed
// To force WebSocket emulator even when native WebSocket available
//window.WEB_SOCKET_FORCE_FLASH = true;
// To enable WebSocket emulator debug:
//window.WEB_SOCKET_DEBUG=1;
//
// Queue public functions
//
// Check to see if we must wait for 'num' bytes (default to FBU.bytes)
// to be available in the receive queue. Return true if we need to
// wait (and possibly print a debug message), otherwise false.
//
// Private utility routines
//
//
// Public Send functions
//
// overridable for testing
//
// Other public functions
// Set event handlers
// Override internal functions for testing
// Takes a send function, returns reference to recv function
function ANSI(e,t,n){this._width=e,this._height=t,this._target="string"==typeof n?document.getElementById(n):n,this._defaultForeground=7,this._defaultBackground=0,this._state=[this._defaultForeground,this._defaultBackground,0],this._lineCounter=0,this._lastLineLength=0,this._noLastSpan=1,this._lastSpan="",this._codeFragment="",this._margin=2}function MClient(){function e(){S=new Terminal("root",{onInput:t}),E=new DataBase({onReady:function(){DEBUG&&(A="d474fa6920bdf02aecb512563167ebc1",I.setPlayerRoom(A))},onError:function(){_.println("ERROR: unable to find or initialize HTML5 data base (IndextedDB),","       configuration and map data won't be saved!")}}),T=Telnet("ANSI",{onConnect:r,onInitGMCP:l,onDisconnect:i,onEchoChanged:a,onReceive:s,onReceiveGMCP:c,onError:function(){_.println("ERROR: unable to connect to server!")}}),C=new Tile("main"),C.setSize(600,500),C.getPane("content").attr("id","mudmap"),C.getPane().css({top:"20px",right:"20px"}),I=new MudMap("mudmap",u,DEBUG),d();var e=Object.getOwnPropertyNames(DRIVERS)[0];if(k=DRIVERS[e],m(),DEBUG){for(var n=0;20>n;n++)_.println("hello "+(n+1));r()}else k&&k.address&&k.port&&T.connect(k.address,k.port,!1,"string"==typeof k.gmcpConfig)}function t(e){var t=_.getCommandPrefix();e.trim().startsWith(t)?n(e.trim().substring(t.length)):o(e)}function n(e){var t=e.trim().split(/\s+/),n=t.length>0?t[0]:void 0,o=t.length>1?t.slice(1):[];if(""===n&&(n="help"),!COMMANDS.hasOwnProperty(n)){var r=[];for(key in COMMANDS)key.startsWith(n)&&r.push(key);if(0===r.length);else{if(1!==r.length){_.println("","Ambiguous client-side command. What did you mean?");for(var i=0;r.length>i;i++)_.println("  "+_.getCommandPrefix()+r[i]);return _.println(),void 0}n=r[0]}}if(COMMANDS.hasOwnProperty(n)){var a=_.getCommandPrefix(),s=COMMANDS[n];s.hasOwnProperty("run")&&s.run(a+n,o,e)}else _.println("","Unknown client-side command: "+_.getCommandPrefix()+n,"")}function o(e){T.isConnected()&&(N=e.trim(),T.send(e+"\n"))}function r(){S.showCursor()}function i(){S.hideCursor(),S.showDisconnectLabel(!0)}function a(e){S.setPasswordMode(!e)}function s(e){_.printANSI(e)}function l(){T.sendGMCP(k.gmcpConfig)}function c(e,t){if("MG.room.info"==e){var n=t.id;n&&h(n,{name:t.short,areaId:t.domain},t.exits,k.exitKeyMapping),d(n,t.short)}}function u(e){p(e,4)}function d(e,t){e!==A&&(A=e,I.setPlayerRoom(A)),e?C.setTitle(t?t:"(unknown room name)"):C.setTitle("... out of world ...")}function h(e,t,n,o){var r=void 0,i=void 0;if(A&&e!==A&&N){var a=N.trim();(o.hasOwnProperty(a)||I.EXIT_KEYS.hasOwnProperty(a))&&(r=A,i=a),N=void 0}f(e,t,n,r,i,o)}function f(e,t,n,o,r,i){e&&e!==I.ID_UNKNOWN&&(E&&E.isReady()?E.updateMany("rooms",[e,o],function(a){for(var s=0;a.length>s;s++){var l=a[s];l&&g(l)}return I.updateRoom(e,t,n,o,r,i),DEBUG_DB_READONLY?[]:[I.getRoom(e),I.getRoom(o)]}):I.updateRoom(e,t,n,o,r,i))}function p(e,t){if(E&&E.isReady()&&e&&e!=I.ID_UNKNOWN){var n=I.getRoom(e);n||(I.updateRoom(e),E.restore("rooms",e,function(e){if(e&&(g(e),e.exits&&t>0))for(exitKey in e.exits){var n=e.exits[exitKey];p(n,t-1)}}))}}function g(e){if(e&&(I.updateAttr(e.id,e.attr,!0),e.exits))for(exitKey in e.exits)I.updateExit(e.id,exitKey,e.exits[exitKey])}function m(){$("#cmdline").css({background:0,outline:0}),v("color",$("#main"),"#000000","#efe5c5"),v("color.tiles",$(".tile"),void 0,"#dfd5b5"),v("color.tiles.header",$(".tile-header"),void 0,"#cfc5a5"),v("color.cmdline",$("#cmdline"),"#C00000",void 0),S.getTile().getPane().css({color:"inherit",background:0});var e=b("color.separator.fore")||"#C0C0C0";$("#separator").css({border:0}),$("#separator").css({"border-bottom":"1px dashed "+e}),I.setColors({roomFore:b("color.map.room.fore",void 0),roomBack:b("color.map.room.back",void 0),linkFore:b("color.map.link.fore",void 0),labelFore:b("color.map.label.fore",void 0)})}function v(e,t,n,o){var r=b(e+".fore")||n;t.css({color:r});var i=b(e+".back")||o;0===i||"0"===i||"none"===i?t.css({background:0}):"string"==typeof i?t.css({"background-color":i}):t.css({"background-color":"inherit"})}function b(e){if(x&&x.hasOwnProperty(e))return x[e];if(k&&k.defaultConfig&&k.defaultConfig.hasOwnProperty(e))return k.defaultConfig[e];var t=w();return t&&t.hasOwnProperty(e)?t[e]:void 0}function y(e,t){x||(x={}),t?x[e]=t:delete x[e]}function w(){if(x){if("string"==typeof x.theme&&THEMES.hasOwnProperty(x.theme))return THEMES[x.theme];if("object"==typeof x.theme)return x.theme}if(k){if("string"==typeof k.theme&&THEMES.hasOwnProperty(k.theme))return THEMES[k.theme];if("object"==typeof k.theme)return k.theme}return void 0}var C,E,S,T,I,k,x,A,N,_=this;_.isDataBaseAvailable=function(){return E&&E.isReady()},_.println=function(){var e=S.getTile();e.println.apply(e,arguments)},_.print=function(){var e=S.getTile();e.print.apply(e,arguments)},_.printANSI=function(){var e=S.getTile();e.printANSI.apply(e,arguments)},_.getCommandPrefix=function(){var e=k&&k.hasOwnProperty("commandPrefix")?k.commandPrefix:void 0;return"string"==typeof e?e:"%"},_.getCommandForExitKey=function(e){if(k&&k.exitKeyMapping){var t=k.exitKeyMapping;for(var n in t)if(t.hasOwnProperty(n)&&t[n]===e)return n}return e},_.setTheme=function(e){e&&THEMES.hasOwnProperty(e)?(y("theme",e),m()):(y("theme"),m())},_.getCurrRoomId=function(){return A},_.setRoomAttribute=function(e,t){f(e,t)},_.readBackup=function(e,t){if(E&&E.isReady()){var n="";E.restoreAll("rooms",function(e,t){n.length>0&&(n+=",\n"),n+="		"+JSON.stringify(t)},function(){n='{\n	"rooms": [\n'+n+"\n"+"	]\n"+"}\n",e(n)},t)}},_.writeBackup=function(e,t,n,o){if(E&&E.isReady())try{var r=JSON.parse(e);r.hasOwnProperty("rooms")&&(E.clear("rooms"),E.storeAll("rooms",r.rooms,function(){I.clear(),t&&t()},o))}catch(i){console.log(i),n&&n(i.message)}},e()}function startup(){function e(e){for(key in e)e.hasOwnProperty(key)&&(e[key].id=key)}e(DRIVERS),e(COMMANDS),e(THEMES),CLIENT=new MClient}function Telnet(e,t){function n(){d.length>0&&(Util.Debug("Sending "+d),c.send(d),d=[])}function o(){var o,s,l,u,p=c.rQshiftBytes(c.rQlen()),g="",m=!1;for(Util.Debug("Received array '"+p+"'");p.length>0;)switch(o=p.shift()){case 255:switch(s=o,l=p.shift(),u=240!==l?p.shift():void 0,l){case 254:1===u&&t.onEchoChanged&&t.onEchoChanged(!1),Util.Info("Got Cmd DONT '"+u+"', ignoring");break;case 253:Util.Info("Got Cmd DO '"+u+"'"),1===u?(t.onEchoChanged&&t.onEchoChanged(!0),Util.Info("Send WILL '"+u+"' (echo)"),d.push(255,251,u)):24===u?(Util.Info("Send WILL '"+u+"' (TERM-TYPE)"),d.push(255,251,u)):31===u?(Util.Info("Send WILL '"+u+"' (NAWS)"),h=1,d.push(255,251,u)):201===u?f?(Util.Info("Send WILL '"+u+"' (TERM-TYPE)"),d.push(255,251,u)):(Util.Info("Send WONT '"+u+"'"),d.push(255,252,u)):(Util.Info("Send WONT '"+u+"'"),d.push(255,252,u));break;case 252:1===u?(t.onEchoChanged&&t.onEchoChanged(!0),Util.Info("Send DONT '"+u+"' (echo)"),d.push(255,254,u)):Util.Info("Got Cmd WONT '"+u+"', ignoring");break;case 251:Util.Info("Got Cmd WILL '"+u+"'"),1===u?(t.onEchoChanged&&t.onEchoChanged(!1),Util.Info("Send Cmd DO '"+u+"' (echo)"),d.push(255,253,u)):201===u?f?(Util.Info("Send Cmd DO '"+u+"' (GMCP)"),d.push(255,253,u),m=!0):(Util.Info("Send Cmd DONT '"+u+"'"),d.push(255,254,u)):(Util.Info("Send Cmd DONT '"+u+"'"),d.push(255,254,u));break;case 250:24===u?(Util.Info("Got IAC SB TERM-TYPE SEND(1) IAC SE"),1===p[0]&&255===p[1]&&240===p[2]?(p.shift(),p.shift(),p.shift(),Util.Info("Send IAC SB TERM-TYPE IS(0) '"+e+"' IAC SE"),d.push(255,250,24,0),d.pushStr(e),d.push(255,240)):Util.Info("Invalid subnegotiation received"+p)):(v=!0,b=u,y="");break;case 240:v&&(a(b,y),v=!1,b=0,y="");break;default:Util.Info("Got Cmd "+s+" "+u+", ignoring")}continue;case 242:s=o,l=p.shift(),u=p.shift(),Util.Info("Ignoring Data Mark (Synch)");break;default:v?y+=String.fromCharCode(o):g+=String.fromCharCode(o)}d&&n(),m&&r(),g&&i(g)}function r(){t.onInitGMCP&&t.onInitGMCP()}function i(e){t.onReceive&&t.onReceive(e)}function a(e,n){if(e===m.GMCP){var o=n.indexOf(" ");if(o>=0){var r=n.substring(0,o).trim(),i=n.substring(o+1).trim();if(r.length>0&&i.length>0){var a=void 0;try{a=JSON.parse(i)}catch(l){}a&&(p[r]=a,s(r,a))}}}t.onReceiveSubnegotiation&&t.onReceiveSubnegotiation(e,n)}function s(e,n){t.onReceiveGMCP&&t.onReceiveGMCP(e,n)}function l(){return c=new Websock,c.on("message",o),c.on("open",function(){Util.Info(">> WebSockets.onopen"),g=!0,t.onConnect&&t.onConnect(),Util.Info("<< WebSockets.onopen")}),c.on("close",function(){Util.Info(">> WebSockets.onclose"),g=!1,t.onDisconnect&&t.onDisconnect(),Util.Info("<< WebSockets.onclose")}),c.on("error",function(e){Util.Info(">> WebSockets.onerror"),u.disconnect(),g=!1,t.onError&&t.onError(e),Util.Info("<< WebSockets.onerror")}),u}var c,u={},d=[],h=0,f=!1,p={},g=!1,m={NULL:0,ECHO:1,SGA:3,BEL:7,BS:8,HT:9,LF:10,NL:10,VT:11,FF:12,CR:13,EOR:25,ESC:27,NAWS:31,LINEMODE:34,COMPRESS:85,COMPRESS2:86,ATCP:200,GMCP:201,EORD:239,SE:240,NOP:241,DM:242,BRK:243,IP:244,AO:245,AYT:246,EC:247,EL:248,GA:249,SB:250,WILL:251,WONT:252,DO:253,DONT:254,IAC:255};Array.prototype.pushStr=function(e){for(var t=e.length,n=0;t>n;n++)this.push(e.charCodeAt(n))};var v=!1,b=0,y="";return u.isConnected=function(){return g},u.connect=function(e,t,n,o){var r,e=e,t=t,i="ws://";return f=o===!0,Util.Debug(">> connect"),e&&t?(c&&c.close(),n&&(i="wss://"),r=i+e+":"+t,Util.Info("connecting to "+r),c.open(r),Util.Debug("<< connect"),void 0):(console.log("must set host and port"),void 0)},u.disconnect=function(){Util.Debug(">> disconnect"),c&&c.close(),Util.Debug("<< disconnect")},u.send=function(e){g&&(d.pushStr(e),n())},u.sendSubnegotiation=function(e,t){g&&(d.push(m.IAC,m.SB,e),d.pushStr(t),d.push(m.IAC,m.SE),n())},u.sendGMCP=function(e){g&&u.sendSubnegotiation(m.GMCP,e)},u.sendSetPageSize=function(e,t){if(h){var o=e[0]/256,r=e[0]%256,i=e[1]/256,a=e[1]%256;d.push(255,250,31),d.push(o),255==o&&d.push(o),d.push(r),255==r&&d.push(r),d.push(i),255==i&&d.push(i),d.push(a),255==a&&d.push(a),d.push(255,240),t&&n()}},u.getGMCP=function(){return p},l()}function Terminal(e,t){function n(){s=new Tile("main",!1,!0),s.hide("header"),s.show("footer"),s.setAllowClose(!1),s.setAllowMove(!1),s.setAllowResize(!1),s.getPane("content").append($('<pre id="terminal" style="width: 100%;"></pre>')),s.getPane("footer").append($('<hr id="separator"/><div id="prompt" style="float: left; padding: 6px;">&gt;</div><div id="cmd" style="margin-left: 1.5em; padding: 6px;">  <input id="cmdline" type="text" style="width: 100%; margin-top:2px; background-color:transparent;" /></div>')),l=s.getPane("footer").find("#cmdline").first(),l.keydown(o);var e=function(){var e=$("#main");s.setOuterSize(e.width(),e.height())};$(window).resize(e),e()}function o(e){if(e.keyCode>=37&&40>=e.keyCode||(f=0),9!==e.keyCode&&(g=0),13==e.keyCode){var t=c.getInput();c.clearInput(),r(t),e.preventDefault()}else if(38==e.keyCode||40==e.keyCode){var n=38==e.keyCode?1:-1;f+n>=0&&h.length>=f+n&&(f+=n,c.setInput(f>0?h[h.length-f]:"")),e.preventDefault()}else if(9==e.keyCode)i(),e.preventDefault();else if(e.keyCode>=96&&105>=e.keyCode){var o=void 0;switch(e.keyCode){case 97:o="sw";break;case 98:o="s";break;case 99:o="se";break;case 100:o="w";break;case 102:o="e";break;case 103:o="nw";break;case 104:o="n";break;case 105:o="ne";break;default:}if(o){var a=CLIENT.getCommandForExitKey(o);a&&r(a,!0)}e.preventDefault()}}function r(e,n){s.scrollToBottom(),u&&!d&&s.println(e),d||n||h.push(e),t.onInput&&t.onInput(e)}function i(){var e=l.val(),t=l.get(0).selectionStart;if("number"!=typeof t)return!1;for(var n=t;n-1>=0&&!/\s/.test(e.charAt(n-1));)n--;for(var o=t;e.length>o&&!/\s/.test(e.charAt(o));)o++;var r=void 0;if(p&&g>0)g>=p.length&&(g=0);else{var i=e.substring(n,t);p=a(i,300),g=0}return r=p.length>0?p[g++]:void 0,r?(e=e.substring(0,n)+r+e.substring(o),l.val(e),l.get(0).selectionStart=n+r.length,l.get(0).selectionEnd=n+r.length,!0):!1}function a(e,t){if(!e||0===e.length||!t||0>t)return[];e=e.toLowerCase();for(var n=s.getPane("content").text(),o=n.trim().split(/\W+/),r=[],i=0;o.length>i&&t>i;i++){var a=o[o.length-1-i];a&&a.length>0&&(a=a.toLowerCase(),a.startsWith(e)&&0>r.indexOf(a)&&r.push(a))}return r}var s,l,c=this,u=!0,d=!1,h=[],f=0,p=void 0,g=0;c.getTile=function(){return s},c.getInput=function(){return l.val()},c.setInput=function(e){l.val(e)},c.clearInput=function(){l.val("")},c.showDisconnectLabel=function(){s.getPane().find("#cmd")[0].innerHTML="<span style='font-style: italic; color: #FF0000;'>Disconnected.</span>"},c.setPasswordMode=function(e){e?d||(c.clearInput(),l[0].type="password",d=!0):d&&(c.clearInput(),l[0].type="text",d=!1)},c.showCursor=function(){l.focus()},c.hideCursor=function(){l.blur()},n()}function Websock(){"use strict";function e(){return R}function t(){return N}function n(){return _}function o(e){_=e}function r(){return N.length-_}function i(){return N[_]}function a(){return N[_++]}function s(e){0===_?N.unshift(e):(_-=1,N[_]=e)}function l(){return(N[_++]<<8)+N[_++]}function c(){return(N[_++]<<24)+(N[_++]<<16)+(N[_++]<<8)+N[_++]}function u(e){e===void 0&&(e=r());var t=N.slice(_,_+e);return _+=e,String.fromCharCode.apply(null,t)}function d(e){return e===void 0&&(e=r()),_+=e,N.slice(_-e,_)}function h(e,t){return t?N.slice(_+e,_+t):N.slice(_+e)}function f(e,t,n){var o=N.length-_;if(t>o){if(n){if(n>_)throw"rQwait cannot backup "+n+" bytes";_-=n}return!0}return!1}function p(){return"binary"===A?new Uint8Array(R).buffer:Base64.encode(R)}function g(e){if("binary"===A)for(var t=new Uint8Array(e),n=0;t.length>n;n++)N.push(t[n]);else N=N.concat(Base64.decode(e,0))}function m(){return 0!==x.bufferedAmount&&Util.Debug("bufferedAmount: "+x.bufferedAmount),x.bufferedAmount<k.maxBufferedAmount?(R.length>0&&(x.send(p(R)),R=[]),!0):(Util.Info("Delaying send, bufferedAmount: "+x.bufferedAmount),!1)}function v(e){return R=R.concat(e),m()}function b(e){k.send(e.split("").map(function(e){return e.charCodeAt(0)}))}function y(e){try{g(e.data),r()>0?(U.message(),N.length>D&&(N=N.slice(_),_=0)):Util.Debug("Ignoring empty message")}catch(t){t.stack!==void 0?Util.Warn("recv_message, caught exception: "+t.stack):t.description!==void 0?Util.Warn("recv_message, caught exception: "+t.description):Util.Warn("recv_message, caught exception:"+t),t.name!==void 0?U.error(t.name+": "+t.message):U.error(t)}}function w(e,t){U[e]=t}function C(e,t){N=[],_=0,R=[],x=null;var n=!1,o=!1;"Uint8Array"in window&&"set"in Uint8Array.prototype&&(n=!0);try{n&&("binaryType"in WebSocket.prototype||new WebSocket(t+"://.").binaryType)&&(Util.Info("Detected binaryType support in WebSockets"),o=!0)}catch(r){}if(e===void 0&&(e=o?["binary","base64"]:"base64"),!o){if("binary"===e)throw"WebSocket binary sub-protocol requested but not supported";if("object"==typeof e){for(var i=[],a=0;e.length>a;a++)"binary"===e[a]?Util.Error("Skipping unsupported WebSocket binary sub-protocol"):i.push(e[a]);if(!(i.length>0))throw"Only WebSocket binary sub-protocol was requested and not supported.";e=i}}return e}function E(e,t){var n=e.match(/^([a-z]+):\/\//)[1];t=C(t,n),O?x={}:(x=new WebSocket(e,t),t.indexOf("binary")>=0&&(x.binaryType="arraybuffer")),x.onmessage=y,x.onopen=function(){Util.Debug(">> WebSock.onopen"),x.protocol?(A=x.protocol,Util.Info("Server chose sub-protocol: "+x.protocol)):(A="base64",Util.Error("Server select no sub-protocol!: "+x.protocol)),U.open(),Util.Debug("<< WebSock.onopen")},x.onclose=function(e){Util.Debug(">> WebSock.onclose"),U.close(e),Util.Debug("<< WebSock.onclose")},x.onerror=function(e){Util.Debug(">> WebSock.onerror: "+e),U.error(e),Util.Debug("<< WebSock.onerror")}}function S(){x&&((x.readyState===WebSocket.OPEN||x.readyState===WebSocket.CONNECTING)&&(Util.Info("Closing WebSocket connection"),x.close()),x.onmessage=function(){})}function T(e,t){return O=!0,A=t,k.send=e,k.close=function(){},y}function I(){return k.maxBufferedAmount=200,k.get_sQ=e,k.get_rQ=t,k.get_rQi=n,k.set_rQi=o,k.rQlen=r,k.rQpeek8=i,k.rQshift8=a,k.rQunshift8=s,k.rQshift16=l,k.rQshift32=c,k.rQshiftStr=u,k.rQshiftBytes=d,k.rQslice=h,k.rQwait=f,k.flush=m,k.send=v,k.send_string=b,k.on=w,k.init=C,k.open=E,k.close=S,k.testMode=T,k}var k={},x=null,A="base64",N=[],_=0,D=1e4,R=[],U={message:function(){},open:function(){},close:function(){},error:function(){}},O=!1;return I()}ANSI.BOLD=1,ANSI.UNDERLINE=2,ANSI.BLINK=4,ANSI.INVERSE=8,ANSI.prototype.setPageSize=function(){var e=this._prompt,t=[],n=0;if(t.push(80),t.push(24),void 0===e.textContent){if(void 0===e.innerHTML)return t;n=1}var o=0;o=n?e.innerText.length:e.textContent.length,this._width=Math.floor(this._target.clientWidth/(e.offsetWidth/o))-1,this._height=Math.floor((window.innerHeight||document.documentElement.clientHeight)/e.offsetHeight-4),40>this._width&&(this._width=80),3>this._height&&(this._height=24);var r=this._width,i=this._height;return t[0]=r,t[1]=i,t},ANSI.prototype.numToCol=function(e,t){switch(e){case 0:return t?"#808080":"#1D1D1D";case 1:return t?"#FF0000":"#B00000";case 2:return t?"#00FF00":"#00B000";case 3:return t?"#FFD700":"#B0B000";case 4:return t?"#0000FF":"#0000B0";case 5:return t?"#FF00FF":"#B000B0";case 6:return t?"#00FFFF":"#00B0B0";case 7:return t?"#FFFFFF":"#C0C0C0"}return""},ANSI.prototype.stateToSpan=function(e,t){this._noLastSpan&&(this._noLastSpan=0);var n='<span style="';return(e[0]!=this._defaultForeground&&!(e[2]&ANSI.INVERSE)||t)&&(n+="color:"+this.numToCol(e[e[2]&ANSI.INVERSE?1:0],e[2]&ANSI.BOLD)+";"),(e[1]!=this._defaultBackground||t)&&(n+="background-color:"+this.numToCol(e[e[2]&ANSI.INVERSE?0:1],0)+";"),e[2]&ANSI.UNDERLINE&&e[2]&ANSI.BLINK?n+="text-decoration:underline blink;":e[2]&ANSI.UNDERLINE?n+="text-decoration:underline;":e[2]&ANSI.BLINK&&(n+="text-decoration:blink;"),e[2]&ANSI.BOLD&&(n+="font-weight:bold;"),'<span style="'==n?(this._lastSpan="",this._noLastSpan=1,""):(this._lastSpan=n+'">',this._lastSpan)},ANSI.prototype.addText=function(e){var t=this._lastSpan;this._lastSpan="";var n=0,o=0,r=0,i=1,a=this._lastLineLength,s="";for(e=this._codeFragment+e,this._codeFragment="";e.length>n;)if(27!=e.charCodeAt(n)){if(32>e.charCodeAt(n)&&10!=e.charCodeAt(n)&&9!=e.charCodeAt(n)&&7!=e.charCodeAt(n)){n++;continue}if(7==e.charCodeAt(n)){if(document.getElementById("beep").checked){var l=document.getElementById("bellSound");l.paused||(l.pause(),l.currentTime=0),l.play()}}else 10==e.charCodeAt(n)?(i=0,a=0):a++;t+="<"==e[n]?"&lt;":">"==e[n]?"&gt;":"&"==e[n]?"&amp;":e[n],n++,a==this._width+(i?this._margin:0)&&(i=0,t+="\n",a=0)}else{var c=this._state[0],u=this._state[1],d=this._state[2];for(o=2;64>e.charCodeAt(n+o)&&e.length>n+o;)o++;for(o++,n+o>=e.length&&(this._codeFragment=e.substr(n,o)),s=e.substr(n+2,o-3).split(";"),r=0;s.length>r;r++)1==s[r].length?"1"==s[r]?this._state[2]|=ANSI.BOLD:"4"==s[r]?this._state[2]|=ANSI.UNDERLINE:"5"==s[r]?this._state[2]|=ANSI.BLINK:"7"==s[r]?this._state[2]|=ANSI.INVERSE:"0"==s[r]&&(this._state[0]=this._defaultForeground,this._state[1]=this._defaultBackground,this._state[2]=0):2==s[r].length&&(s[r]=parseInt(s[r]),s[r]>=30&&39>=s[r]?this._state[0]=39==s[r]?this._defaultForeground:s[r]-30:s[r]>=40&&49>=s[r]&&(this._state[1]=s[r]-40)),(this._state[0]!=c||this._state[1]!=u||this._state[2]!=d)&&(t+=(this._noLastSpan?"":"</span>")+this.stateToSpan(this._state),c=this._state[0],u=this._state[1],d=this._state[2]),n+=o}this._noLastSpan||(t+="</span>"),this._lastLineLength=t.split("\n").pop().replace(/(<([^>]+)>)/gi,"").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&").length,this._lineCounter+=t.split("\n").length-1;var h=document.createElement("span");for(h.innerHTML=t;h.firstChild;)""==h.firstChild.innerHTML?h.removeChild(h.firstChild):this._target.appendChild(h.firstChild)},ANSI.prototype.write=function(e){var t=0,n="";for(t=0;e.length>t;t++)e.charCodeAt(t)>=32||27==e.charCodeAt(t)||10==e.charCodeAt(t)||9==e.charCodeAt(t)||7==e.charCodeAt(t)?n+=e[t]:8==e.charCodeAt(t)&&n.length>0&&(n=n.substr(0,n.length-1));this.addText(n)};var COMMANDS={};COMMANDS.help={"short":"show information on available client-side commands",run:function(){var e=CLIENT.getCommandPrefix();CLIENT.println("","You can use commands starting with "+e+" to customize the client.","All these commands are client-side only, they do not affect the MUD.","","These are the available client commands:");for(id in COMMANDS){var t="  "+e+id;COMMANDS[id].short&&(t+=" - "+COMMANDS[id].short),CLIENT.println(t)}CLIENT.println()}},COMMANDS.themes={"short":"list or choose from available color themes",run:function(e,t){if(0===t.length){CLIENT.println("","The client can be customized by using themes. Each theme provides a","set of colors.","","These are the available themes:");for(id in THEMES)CLIENT.println("  "+id);CLIENT.println("",'To activate one of those themes simply enter "'+e+' <name>".','To clear the currently active theme enter "'+e+' none".',"")}else{var n=t[0];"none"===n?(CLIENT.println("","Deactivating the currently active theme (if any).",""),CLIENT.setTheme(void 0)):THEMES.hasOwnProperty(n)?(CLIENT.println("","Activating theme "+n+".",""),CLIENT.setTheme(n)):CLIENT.println("","No such theme: +themeId+","")}}},COMMANDS.label={"short":"set a label for the current room shown on the map",run:function(e,t){if(0===t.length)CLIENT.println("","Sets a label for the current room. These labels are shown on the map.","By default, labels are shown in the center of the room. You can change",'this using the format "&lt;exit key>|&lt;label>". For example, setting the','label to "ne|Smaug\'s lair" will show the label "Smaug\'s lair" on',"the map to the north east of the current room.","");else{for(var n=CLIENT.getCurrRoomId(),o="",r=0;t.length>r;r++)r>0&&(o+=" "),o+=t[r];n?0===o.trim().length||"none"===o?(CLIENT.println("","Removing label of current room.",""),CLIENT.setRoomAttribute(n,{label:null})):(CLIENT.println("",'Setting label of current room to "'+o+'".',""),CLIENT.setRoomAttribute(n,{label:o})):CLIENT.println("","Cannot set label of current room: no current room.","")}}},COMMANDS.backup={"short":"store or restore a backup of all local data to/from your hard drive",run:function(e,t){if(CLIENT.isDataBaseAvailable())if(1!==t.length)CLIENT.println("",'Syntax is either "'+e+' store" or "'+e+' restore".',"");else{var n=t[0];if("store".startsWith(n))CLIENT.println(),CLIENT.println("Save the backup file to your local hard drive ..."),CLIENT.readBackup(function(e){var t=document.createElement("a");return"download"in t?(t.setAttribute("href","data:application/json;base64,"+btoa(e)),t.setAttribute("download","rooms.json"),document.body.appendChild(t),t.click(),document.body.removeChild(t),void 0):(CLIENT.println("ERROR: your browser does not support HTML5 local downloads!"),void 0)});else if("restore".startsWith(n)){$("#input-upload-backup").remove(),CLIENT.println(),CLIENT.println("To restore a backup, please select the backup file on your local drive:"),CLIENT.print('<p><input type="file" id="input-upload-backup"></p>');var o=$("#input-upload-backup");o.change(function(e){var t=e.target.files[0];if(t){o.replaceWith('Reading file "'+t.name+'" ...');var n=new FileReader;n.onload=function(e){CLIENT.println("done.");var t=e.target.result;CLIENT.writeBackup(t,function(){CLIENT.println("All data successfully restored.")},function(e){CLIENT.println("ERROR while parsing backup data in file:",e)},function(){CLIENT.println("ERROR while writing data into data base. Data may be invalid!")})},n.readAsText(t)}})}else CLIENT.println(""),CLIENT.println('Argument may only be "store" or "restore".')}else CLIENT.println("","Command "+e+" disabled because HTML5 data base (IndextedDB) not available.","")}};var DataBase=function(e){function t(){n()}function n(){if(indexedDB&&!DEBUG_DB_UNAVAILABLE){var t=indexedDB.open("mclient_db",1);t.onerror=function(){e&&e.onError&&e.onError()},t.onupgradeneeded=function(t){var n=t.target.result,r=n.createObjectStore("rooms",{keyPath:"id"});r.transaction.oncomplete=function(){o=n,e&&e.onReady&&e.onReady()}},t.onsuccess=function(){o=t.result,e&&e.onReady&&e.onReady()}}else e&&e.onError&&e.onError()}var o,r=this;r.isReady=function(){return o&&!0},r.store=function(e,t,n,r,i){n.id=t;var a=o.transaction([e],"readwrite").objectStore(e).put(n);i&&(a.onerror=i),r&&(a.onsuccess=function(e){r(a.result,e)})},r.restore=function(e,t,n,r){var i=o.transaction([e],"readonly").objectStore(e).get(t);r&&(i.onerror=r),n&&(i.onsuccess=function(e){n(i.result,e)})},r.storeAll=function(e,t,n,r){var i=o.transaction([e],"readwrite").objectStore(e),a=0,s=function(){if(t.length>a){var e=t[a++],o=i.put(e);r&&(o.onerror=r),o.onsuccess=s}else n&&n()};s()},r.restoreAll=function(e,t,n,r){if(t){var i=o.transaction([e],"readonly").objectStore(e).openCursor();r&&(i.onerror=r),i.onsuccess=function(e){var o=e.target.result;o?(t(o.key,o.value),o.continue()):n&&n()}}},r.update=function(e,t,n,r,i){var a=o.transaction([e],"readwrite").objectStore(e),s=a.get(t);i&&(s.onerror=i),n&&(s.onsuccess=function(e){var o=s.result,l=n(o,e);if(l===void 0&&(l=o),l){l.id=t;var c=a.put(l);i&&(c.onerror=i),r&&(c.onsuccess=function(e){r(c.result,e)})}})},r.updateMany=function(e,t,n,r,i){function a(e,t,n,o,r){if(n>=0&&t.length>n){var s=t[n];if(s){var l=e.get(s);l.onerror=i,l.onsuccess=function(i){o.push(i.target.result),a(e,t,n+1,o,r)}}else a(e,t,n+1,o,r)}else r&&r()}function s(e,t,n,o){if(n>=0&&t.length>n){var r=t[n];if(r){var a=e.put(r);a.onerror=i,a.onsuccess=function(){s(e,t,n+1,o)}}else s(e,t,n+1,o)}else o&&o()}if(!(0>=t.length)&&n){var l=o.transaction([e],"readwrite").objectStore(e),c=[];a(l,t,0,c,function(){var e=n(c);s(l,e||c,0,r)})}},r.delete=function(e,t){o.transaction([e],"readwrite").objectStore(e).delete(t)},r.clear=function(e,t,n){var r=o.transaction([e],"readwrite").objectStore(e).clear();t&&(r.onsuccess=t),n&&(r.onerror=n)},t()},DRIVERS={};DRIVERS["mg.mud.de"]={name:"MorgenGrauen",address:"87.79.24.60",port:"8003",gmcpConfig:"Core.Supports.Set [ 'MG.char 1', 'MG.room 1', 'comm.channel 1' ]",exitKeyMapping:{norden:"n",sueden:"s",westen:"w",osten:"e",o:"e",nordosten:"ne",no:"ne",nordwesten:"nw",suedosten:"se",so:"se",suedwesten:"sw",oben:"u",ob:"u",unten:"d",unt:"d",u:"d"}};var MudMap=function(e,t,n){function o(){O=100,L=100,S=document.createElement("canvas"),S.width=O,S.height=L,S.style.position="absolute",S.style.zIndex=1,I=document.createElement("canvas"),I.width=O,I.height=L,I.style.position="absolute",I.style.zIndex=2,x=document.createElement("canvas"),x.width=O,x.height=L,C=$("#"+e),E=document.getElementById(e),E.appendChild(S),E.appendChild(I),T=S.getContext("2d"),k=I.getContext("2d"),A=x.getContext("2d"),T.shadowBlur=0,k.shadowBlur=0,A.shadowBlur=0,y.setColors(),n&&(y.updateAttr("id01",{name:"Room 1",label:"start"}),y.updateAttr("id02",{name:"Room 2"}),y.updateAttr("id03",{name:"Room 3",label:"n|dead end"}),y.updateAttr("id04",{name:"Room 4",label:"ne|off the beaten path"}),y.updateAttr("id05",{name:"Room 5"}),y.updateAttr("id06",{name:"Room 6",label:"s|Gollum's cave"}),y.updateExit("id01","n","id02",!0),y.updateExit("id02","n","id03",!0),y.updateExit("id02","e","id04",!0),y.updateExit("id04","se","id05",!0),y.updateExit("id05","se","id06",!1),_="id01"),y.refresh(),r()}function r(){y.update(),requestAnimationFrame(r)}function i(e,t){e&&e!=w&&(t?(t.id=e,Q[e]=t):delete Q[e])}function a(e){return e&&e!=w?Q[e]:void 0}function s(){R=[];var e={},n=[],o=void 0;if(_){var r=y.getRoom(_);r?(n.push({x:0,y:0,room:r}),N&&(o=r.attr.areaId)):t&&t(_)}for(;n.length>0;){for(var i=0;n.length>i;i++){var a=n[i];void 0===c(a.x,a.y)?u(a.x,a.y,a.room):a.room=void 0}for(var s=[],i=0;n.length>i;i++){var a=n[i],d=a.room;if(d)for(exitKey in V){var h=d.exits[exitKey];if(h&&h!=w){var f=y.getRoom(h);if(f){var p=e.hasOwnProperty(h),v=o&&d.attr.areaId&&o!=d.attr.areaId,b=d.attr&&d.attr.label&&exitKey===m(d.attr.label);if(!p&&!v&&!b){e[h]=!0;var C=g(exitKey),E=a.x+C.x,S=a.y+C.y;l(E,S)&&s.push({x:E,y:S,room:f})}}else t&&t(h)}}}n=s}}function l(e,t){return e>=-D&&D>=e&&t>=-D&&D>=t}function c(e,t){return l(e,t)?R[(t+D)*(2*D+1)+(e+D)]:void 0}function u(e,t,n){l(e,t)&&(R[(t+D)*(2*D+1)+(e+D)]=n)}function d(e,t,n,o,r,i,a,s,l){var c;e.beginPath(),e.moveTo(t,n),e.lineTo(o,r),e.stroke(),i&&(c=Math.atan((r-n)/(o-t))+(o>=t?-90:90)*Math.PI/180,h(e,t,n,s,l,c)),a&&(c=Math.atan((r-n)/(o-t))+(o>=t?90:-90)*Math.PI/180,h(e,o,r,s,l,c))}function h(e,t,n,o,r,i){e.save(),e.beginPath(),e.translate(t,n),e.rotate(i),e.moveTo(0,0),e.lineTo(o,r),e.lineTo(-o,r),e.closePath(),e.restore(),e.fill()}function f(e){return e&&V.hasOwnProperty(e)}function p(e){return V[e]}function g(e){return{x:Math.sign(X[e].dx),y:Math.sign(X[e].dy)}}function m(e){var t=e.indexOf("|"),n=t>=0?e.substring(0,t):void 0;return f(n)?n:void 0}function v(e){var t=e.indexOf("|");return t>=0?e.substring(t+1):e}function b(e,t,n){if(void 0===n);else if(null===n){if(e.hasOwnProperty(t))return delete e[t],!0}else if(!e.hasOwnProperty(t)||e[t]!==n)return e[t]=n,!0;return!1}var y=this,w="UNKNOWN";y.ID_UNKNOWN=w;var C,E,S,T,I,k,x,A,N=!1,_=void 0,D=6,R=[],U={},O=void 0,L=void 0,M=0,B=0,P=0,F=0,W=!1,z=40,H=40,G=22,K=22,j=!1,Y=!1,q=!1;y.setColors=function(e){e||(e={}),U.roomFore=e.roomFore||"#000000",U.roomBack=e.roomBack||"#DDDDDD",U.linkFore=e.linkFore||"#000000",U.labelFore=e.labelFore||"#000000",y.touch()},y.setStopAtAreaBorder=function(e){"boolean"==typeof e&&e!==N&&(N=e,y.refresh())},y.setPlayerRoom=function(e){e!=w&&e!==_&&(_=e,y.refresh())},y.clear=function(){Q={},y.refresh()};var Q={};y.getRoom=function(e){return a(e)},y.updateRoom=function(e,t,n,o,r,s){if(e&&e!=w){var l=a(e);if(l||(l={id:e,attr:{},exits:{}},i(e,l),y.refresh()),t&&y.updateAttr(e,t,!1),n){var c=[];if($.isArray(n))for(var u=0;n.length>u;u++){var d=n[u],h=s&&s.hasOwnProperty(d)?s[d]:d;y.updateExit(e,h,w),c.push(h)}else if("object"==typeof n)for(var d in n){var h=s&&s.hasOwnProperty(d)?s[d]:d;y.updateExit(e,h,n[d]),c.push(h)}for(var d in V)0>c.indexOf(d)&&y.updateExit(e,d,void 0)}if(r&&o){var f=s&&s.hasOwnProperty(r)?s[r]:r;y.updateExit(o,f,e,!1,!0)}return l}return void 0},y.updateAttr=function(e,t,n){if(e&&e!=w){var o=!1,r=y.updateRoom(e);if(t){n&&(r.attr={},o=!0);for(key in t)t.hasOwnProperty(key)&&(o=b(r.attr,key,t[key])||o)}return o&&(i(e,r),y.refresh()),r}return void 0},y.updateExit=function(e,t,n,o,r){if(e&&e!=w&&f(t)){var a=!1,s=y.updateRoom(e);if(n){if(n==w)s.exits.hasOwnProperty(t)||(s.exits[t]=w,a=!0);else if(s.exits[t]=n,a=!0,o||r){var l=y.updateRoom(n),c=p(t),u=!l.exits[c]||l.exits[c]===w;(o||u)&&(l.exits[c]=e,i(n,l))}}else s.exits.hasOwnProperty(t)&&(delete s.exits[t],a=!0);a&&(i(e,s),y.refresh())}},y.refresh=function(){j=!0,y.touch()},y.touch=function(){Y=!0,q=!0},y.touchBackground=function(){Y=!0},y.touchForeground=function(){q=!0},y.update=function(){j&&s(),y.resizeIfRequired();var e=P-M,t=F-B;if(0!=e||0!=t){if(W){var n=10;e>n&&(e=n),-n>e&&(e=-n),t>n&&(t=n),-n>t&&(t=-n)}M+=e,B+=t,y.touchBackground()}y.paintIfRequired()},y.resizeIfRequired=function(){var e=C.width(),t=C.height();(e!==O||t!==L)&&y.resize(e,t)},y.resize=function(e,t){O=e,L=t,S.width=O,S.height=L,I.width=O,I.height=L,x.width=O,x.height=L,y.touch()},y.paintIfRequired=function(){(Y||q)&&y.paint()},y.paint=function(){if(Y)if(R&&R.length>0){var e=Math.round(O/2),t=Math.round(L/2);A.clearRect(0,0,O,L),A.strokeStyle=U.roomFore,A.fillStyle=U.roomBack;for(var n=-D;D>=n;n++)for(var o=-D;D>=o;o++){var r=c(o,n);if(r){var i=e+o*z-G/2,a=t+n*H-K/2;A.fillRect(i,a,G,K),A.strokeRect(i,a,G,K),_&&r.id===_&&A.strokeRect(i-1,a-1,G+2,K+2)}}A.strokeStyle=U.linkFore,A.fillStyle=U.linkFore;for(var n=-D;D>=n;n++)for(var o=-D;D>=o;o++){var r=c(o,n);if(r)for(S in r.exits){var s=r.exits[S];if(s){var l=y.getRoom(s),u=g(S),h=c(o+u.x,n+u.y),i=e+o*z,a=t+n*H,f=!l||!h||h.id!=s;if(f)d(A,i+u.x*G/2,a+u.y*K/2,i+u.x*G/2+.33*u.x*(z-G),a+u.y*K/2+.33*u.y*(H-K));else{var b=p(S),w=l.exits[b]===r.id,C=w&&0>=u.x&&0>=u.y;C||d(A,i+u.x*G/2,a+u.y*K/2,i+u.x*G/2+u.x*(z-G),a+u.y*K/2+u.y*(H-K),!1,!w,4,6)}}}}A.strokeStyle=U.labelFore,A.fillStyle=U.labelFore;for(var n=-D;D>=n;n++)for(var o=-D;D>=o;o++){var r=c(o,n),E=r&&r.attr?r.attr.label:void 0;if("string"==typeof E){var S=m(E),I=v(E),i=e+o*z,a=t+n*H;if(S){var u=g(S);i+=u.x*(G/2+4),a+=u.y*(K/2+4),A.textAlign=u.x>0?"left":0>u.x?"right":"center",A.textBaseline=u.y>0?"top":0>u.y?"bottom":"middle"
}else A.textAlign="center",A.textBaseline="middle";A.fillText(I,i,a)}}T.clearRect(0,0,O,L),T.drawImage(x,0,0)}else T.clearRect(0,0,O,L);(q||Y)&&k.clearRect(0,0,O,L),Y=!1,q=!1};var V={n:"s",s:"n",w:"e",e:"w",ne:"sw",nw:"se",se:"nw",sw:"ne"};y.EXIT_KEYS=V;var X={n:{dx:0,dy:-1},s:{dx:0,dy:1},w:{dx:-1,dy:0},e:{dx:1,dy:0},ne:{dx:1,dy:-1},nw:{dx:-1,dy:-1},se:{dx:1,dy:1},sw:{dx:-1,dy:1}};o()},DEBUG=!1,DEBUG_DB_READONLY=!1,DEBUG_DB_UNAVAILABLE=!1,CLIENT;window.onload=function(){startup()},String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,t){return t=t||0,this.lastIndexOf(e,t)===t}}),Math.sign||Object.defineProperty(Math,"sign",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return e=+e,0===e||isNaN(e)?e:e>0?1:-1}});var THEMES={};THEMES.chestnut={"color.fore":"#000000","color.back":"#efe5c5","color.tiles.fore":void 0,"color.tiles.back":"#dfd5b5","color.tiles.header.fore":void 0,"color.tiles.header.back":"#cfc5a5","color.cmdline.fore":"#C00000","color.separator.fore":"#C0C0C0","color.map.room.fore":"#000000","color.map.room.back":"#DDDDDD","color.map.link.fore":"#000000","color.map.label.fore":"#000000"},THEMES.dark={"color.fore":"#C0C0C0","color.back":"#1D1D1D","color.tiles.fore":void 0,"color.tiles.back":"#2D2D2D","color.tiles.header.fore":void 0,"color.tiles.header.back":"#3D3D3D","color.cmdline.fore":"#C0C0C0","color.separator.fore":"#C0F0F0","color.map.room.fore":"#C0C0C0","color.map.room.back":"#303060","color.map.link.fore":"#C0C0C0","color.map.label.fore":"#C0C0C0"},THEMES.frog={"color.fore":"#103010","color.back":"#cfe5c5","color.tiles.fore":void 0,"color.tiles.back":"#bfd5b5","color.tiles.header.fore":void 0,"color.tiles.header.back":"#afc5a5","color.cmdline.fore":"#008000","color.separator.fore":"#A0E0A0","color.map.room.fore":"#000000","color.map.room.back":"#DDDDDD","color.map.link.fore":"#000000","color.map.label.fore":"#000000"};var Tile=function(e,t,n){this.$elem=$('<div class="tile" style="position: absolute;"></div>'),this.$header=$('<div class="tile-header" width="100%"></div>'),this.$content=$('<div class="tile-content" width="100%" height="100%" style="overflow-x: '+(t?"scroll":"hidden")+"; overflow-y: "+(n?"scroll":"hidden")+';"></div>'),this.$footer=$('<div class="tile-footer" width="100%"></div>'),this.$buttonClose=$('<div class="tile-button-close" style="position: absolute; top: 0px; right: 0px">[X]</div>'),this.$buttonResize=$('<div class="tile-button-resize" style="position: absolute; width: 30px; height: 30px; bottom: 0px; right: 0px; cursor: se-resize;"></div>'),this.$elem.append(this.$header),this.$elem.append(this.$content),this.$elem.append(this.$footer),this.$elem.append(this.$buttonClose),this.$elem.append(this.$buttonResize),this.$buttonClose.css({zIndex:"1000"}),this.$buttonResize.css({zIndex:"1000"}),this.$header.css({"-moz-user-select":"-moz-none","-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}),this.$buttonClose.css({"-moz-user-select":"-moz-none","-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}),this.$buttonResize.css({"-moz-user-select":"-moz-none","-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}),this.$header.mousedown(this,Tile.handlers.mousedown),this.$buttonResize.mousedown(this,Tile.handlers.mousedown),this.$header.on("touchstart",this,Tile.handlers.touchstart),this.$buttonResize.on("touchstart",this,Tile.handlers.touchstart),this.$buttonClose.click(this,Tile.handlers.close),Tile.config.defaultCSS&&this.$elem.css(Tile.config.defaultCSS),Tile.config.debug&&(this.$elem.css("border","1px solid #FF0000"),this.$header.css("border","1px solid #0000FF"),this.$content.css("border","1px solid #00FF00"),this.$footer.css("border","1px solid #0000FF")),e&&$("#"+e).append(this.$elem),this.setTitle("(no title set)"),this.hide("footer")};Tile.prototype.getPane=function(e){return"header"===e?this.$header:"content"===e?this.$content:"footer"===e?this.$footer:this.$elem},Tile.prototype.setBounds=function(e,t,n,o){this.setPos(e,t),this.setSize(n,o)},Tile.prototype.getPos=function(){var e=this.$elem.offset();return{x:e.left,y:e.top}},Tile.prototype.setPos=function(e,t){this.$elem.offset({left:e,top:t})},Tile.prototype.getSize=function(){return{x:this.$elem.width(),y:this.$elem.height()}},Tile.prototype.setSize=function(e,t){this.$elem.width(e),this.$elem.height(t),this.layout()},Tile.prototype.setOuterSize=function(e,t){var n=this.$elem.outerWidth()-this.$elem.width(),o=this.$elem.outerHeight()-this.$elem.height();this.setSize(e-n,t-o)},Tile.prototype.layout=function(){var e=this.isHidden("header")?0:this.$header.outerHeight(!0),t=this.isHidden("footer")?0:this.$footer.outerHeight(!0),n=this.$content.outerHeight()-this.$content.height();this.$content.height(this.$elem.height()-e-t-n)},Tile.prototype.isHidden=function(e){return this.getPane(e).is(":hidden")},Tile.prototype.hide=function(e){"content"!==e&&this.getPane(e).hide()},Tile.prototype.show=function(e){"content"!==e&&this.getPane(e).show()},Tile.prototype.bringToTop=function(){$(this.$elem).parent().append(this.$elem)},Tile.prototype.setAllowClose=function(e){e?this.$buttonClose.show():this.$buttonClose.hide()},Tile.prototype.setAllowMove=function(){},Tile.prototype.setAllowResize=function(e){e?this.$buttonResize.show():this.$buttonResize.hide()},Tile.prototype.setTitle=function(e){this.$header.text(e)},Tile.prototype.hideTitle=function(){this.$header.hide()},Tile.prototype.showTitle=function(){this.$header.show()},Tile.prototype.isScrolledToBottom=function(){return this.$content[0].scrollTop+this.$content.height()>=this.$content[0].scrollHeight-2},Tile.prototype.scrollToBottom=function(){this.$content[0].scrollTop=this.$content[0].scrollHeight},Tile.prototype.println=function(){var e="";if(0===arguments.length)e+="\n";else for(var t=0;arguments.length>t;t++)e+=arguments[t]+"\n";this.print(e)},Tile.prototype.print=function(){for(var e="",t=0;arguments.length>t;t++)e+=arguments[t];if(0!==e.length){var n=this.isScrolledToBottom(),o=this._getOrCreatePRE();o.append(e),n&&this.scrollToBottom()}},Tile.prototype.printANSI=function(){for(var e="",t=0;arguments.length>t;t++)e+=arguments[t];if(0!==e.length){var n=this.isScrolledToBottom();this._getOrCreateANSI().write(e),n&&this.scrollToBottom()}},Tile.prototype._getOrCreatePRE=function(){var e=this.$content.find("pre").first();return 0===e.length&&(e=$("<pre></pre>"),this.$content.append(e)),e},Tile.prototype._getOrCreateANSI=function(){if(!this._ansi){var e=this._getOrCreatePRE();this._ansi=new ANSI(80,36,e[0])}return this._ansi},Tile.config={debug:!1,defaultCSS:{padding:0,margin:0,border:"none"}},Tile.handlers={windowHandlersInstalled:!1,drag:void 0,close:function(e){var t=e.data;t.hide()},mousedown:function(e){Tile.handlers.windowHandlersInstalled||($(window).mousemove(Tile.handlers.mousemove),$(window).mouseup(Tile.handlers.mouseup),$(window).on("touchmove",Tile.handlers.touchmove),$(window).on("touchend",Tile.handlers.touchend),Tile.handlers.windowHandlersInstalled=!0);var t=e;e.originalEvent&&e.originalEvent.touches&&(e.preventDefault(),t=e.originalEvent.touches[0]);var n=e.data;if(n.bringToTop(),e.target===n.$header.get(0)){var o=n.getPos();Tile.handlers.drag={mode:"move",tile:n,delta:{x:t.pageX-o.x,y:t.pageY-o.y}}}else if(e.target===n.$buttonResize.get(0)){var r=n.getSize();Tile.handlers.drag={mode:"resize",tile:n,delta:{x:t.pageX-r.x,y:t.pageY-r.y}}}},mousemove:function(e){var t=e;e.originalEvent&&e.originalEvent.touches&&(e.preventDefault(),t=e.originalEvent.touches[0]);var n=Tile.handlers.drag;if(n)if("move"===n.mode)n.tile.setPos(t.pageX-n.delta.x,t.pageY-n.delta.y);else if("resize"===n.mode){var o=n.tile.getPos();n.tile.setBounds(o.x,o.y,t.pageX-n.delta.x,t.pageY-n.delta.y)}},mouseup:function(e){e.originalEvent&&e.originalEvent.touches&&e.preventDefault(),Tile.handlers.drag=void 0},touchstart:function(e){Tile.handlers.mousedown(e)},touchmove:function(e){Tile.handlers.mousemove(e)},touchend:function(e){Tile.handlers.mouseup(e)}};var Base64={toBase64Table:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),base64Pad:"=",encode:function(e){"use strict";var t,n="",o=Base64.toBase64Table,r=Base64.base64Pad,i=e.length;for(t=0;i-2>t;t+=3)n+=o[e[t]>>2],n+=o[((3&e[t])<<4)+(e[t+1]>>4)],n+=o[((15&e[t+1])<<2)+(e[t+2]>>6)],n+=o[63&e[t+2]];return i%3&&(t=i-i%3,n+=o[e[t]>>2],2===i%3?(n+=o[((3&e[t])<<4)+(e[t+1]>>4)],n+=o[(15&e[t+1])<<2],n+=r):(n+=o[(3&e[t])<<4],n+=r+r)),n},toBinaryTable:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1],decode:function(e,t){"use strict";t=t!==void 0?t:0;var n,o,r,i,a,s,l=Base64.toBinaryTable,c=Base64.base64Pad,u=0,d=0,h=e.indexOf("=")-t;for(0>h&&(h=e.length-t),o=3*(h>>2)+Math.floor(h%4/1.5),n=Array(o),r=0,i=t;e.length>i;i++)a=l[127&e.charCodeAt(i)],s=e.charAt(i)===c,-1!==a?(d=d<<6|a,u+=6,u>=8&&(u-=8,s||(n[r++]=255&d>>u),d&=(1<<u)-1)):console.error("Illegal character code "+e.charCodeAt(i)+" at position "+i);if(u)throw{name:"Base64-Error",message:"Corrupted base64 string"};return n}},Util={};Array.prototype.push8=function(e){this.push(255&e)},Array.prototype.push16=function(e){this.push(255&e>>8,255&e)},Array.prototype.push32=function(e){this.push(255&e>>24,255&e>>16,255&e>>8,255&e)},Array.prototype.map||(Array.prototype.map=function(e){var t=this.length;if("function"!=typeof e)throw new TypeError;for(var n=Array(t),o=arguments[1],r=0;t>r;r++)r in this&&(n[r]=e.call(o,this[r],r,this));return n}),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),Util._log_level="warn",Util.init_logging=function(e){switch(e===void 0?e=Util._log_level:Util._log_level=e,window.console===void 0&&(window.console=window.opera!==void 0?{log:window.opera.postError,warn:window.opera.postError,error:window.opera.postError}:{log:function(){},warn:function(){},error:function(){}}),Util.Debug=Util.Info=Util.Warn=Util.Error=function(){},e){case"debug":Util.Debug=function(e){console.log(e)};case"info":Util.Info=function(e){console.log(e)};case"warn":Util.Warn=function(e){console.warn(e)};case"error":Util.Error=function(e){console.error(e)};case"none":break;default:throw"invalid logging type '"+e+"'"}},Util.get_logging=function(){return Util._log_level},Util.init_logging(),Util.conf_default=function(e,t,n,o,r,i,a,s){var l,c;l=function(t){return i in{arr:1,array:1}&&t!==void 0?e[o][t]:e[o]},c=function(t,n){i in{"boolean":1,bool:1}?t=!t||t in{0:1,no:1,"false":1}?!1:!0:i in{integer:1,"int":1}?t=parseInt(t,10):"str"===i?t+="":"func"===i&&(t||(t=function(){})),n!==void 0?e[o][n]=t:e[o]=t},t[o+"_description"]=s,t["get_"+o]===void 0&&(t["get_"+o]=l),t["set_"+o]===void 0&&(t["set_"+o]=function(t,n){if(r in{RO:1,ro:1})throw o+" is read-only";if(r in{WO:1,wo:1}&&e[o]!==void 0)throw o+" can only be set once";c(t,n)}),n[o]!==void 0?a=n[o]:i in{arr:1,array:1}&&!(a instanceof Array)&&(a=[]),c(a)},Util.conf_defaults=function(e,t,n,o){var r;for(r=0;o.length>r;r++)Util.conf_default(e,t,n,o[r][0],o[r][1],o[r][2],o[r][3],o[r][4])},Util.get_include_uri=function(){return"undefined"!=typeof INCLUDE_URI?INCLUDE_URI:"include/"},Util._loading_scripts=[],Util._pending_scripts=[],Util.load_scripts=function(e){for(var t,n=document.getElementsByTagName("head")[0],o=Util._loading_scripts,r=Util._pending_scripts,i=0;e.length>i;i++)t=document.createElement("script"),t.type="text/javascript",t.src=Util.get_include_uri()+e[i],t.onload=t.onreadystatechange=function(){for(;o.length>0&&("loaded"===o[0].readyState||"complete"===o[0].readyState);){var e=o.shift();n.appendChild(e)}(!this.readyState||Util.Engine.presto&&"loaded"===this.readyState||"complete"===this.readyState)&&r.indexOf(this)>=0&&(this.onload=this.onreadystatechange=null,r.splice(r.indexOf(this),1),0===r.length&&window.onscriptsload&&window.onscriptsload())},Util.Engine.trident?o.push(t):(t.async=!1,n.appendChild(t)),r.push(t)},Util.getPosition=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop,e=e.offsetParent;while(e);return{x:t,y:n}},Util.getEventPosition=function(e,t,n){var o,r,i,a;return o=e?e:window.event,o=o.changedTouches?o.changedTouches[0]:o.touches?o.touches[0]:o,o.pageX||o.pageY?(r=o.pageX,i=o.pageY):(o.clientX||o.clientY)&&(r=o.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=o.clientY+document.body.scrollTop+document.documentElement.scrollTop),a=Util.getPosition(t),n===void 0&&(n=1),{x:(r-a.x)/n,y:(i-a.y)/n}},Util.addEvent=function(e,t,n){if(e.attachEvent){var o=e.attachEvent("on"+t,n);return o}if(e.addEventListener)return e.addEventListener(t,n,!1),!0;throw"Handler could not be attached"},Util.removeEvent=function(e,t,n){if(e.detachEvent){var o=e.detachEvent("on"+t,n);return o}if(e.removeEventListener)return e.removeEventListener(t,n,!1),!0;throw"Handler could not be removed"},Util.stopEvent=function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault?e.preventDefault():e.returnValue=!1},Util.Features={xpath:!!document.evaluate,air:!!window.runtime,query:!!document.querySelector},Util.Engine={presto:function(){return window.opera?!0:!1}(),trident:function(){return window.ActiveXObject?window.XMLHttpRequest?document.querySelectorAll?6:5:4:!1}(),webkit:function(){try{return navigator.taintEnabled?!1:Util.Features.xpath?Util.Features.query?525:420:419}catch(e){return!1}}(),gecko:function(){return document.getBoxObjectFor||null!=window.mozInnerScreenX?document.getElementsByClassName?19:18:!1}()},Util.Engine.webkit&&(Util.Engine.webkit=function(e){var t=RegExp("WebKit/([0-9.]*) ");return e=(navigator.userAgent.match(t)||["",e])[1],parseFloat(e,10)}(Util.Engine.webkit)),Util.Flash=function(){var e,t;try{e=navigator.plugins["Shockwave Flash"].description}catch(n){try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(o){e="0 r0"}}return t=e.match(/\d+/g),{version:parseInt(t[0]||"0."+t[1],10)||0,build:parseInt(t[2],10)||0}}(),window.WebSocket&&!window.WEB_SOCKET_FORCE_FLASH?Websock_native=!0:window.MozWebSocket&&!window.WEB_SOCKET_FORCE_FLASH?(Websock_native=!0,window.WebSocket=window.MozWebSocket):(Websock_native=!1,function(){window.WEB_SOCKET_SWF_LOCATION=Util.get_include_uri()+"web-socket-js/WebSocketMain.swf",Util.Engine.trident&&(Util.Debug("Forcing uncached load of WebSocketMain.swf"),window.WEB_SOCKET_SWF_LOCATION+="?"+Math.random()),Util.load_scripts(["web-socket-js/swfobject.js","web-socket-js/web_socket.js"])}());